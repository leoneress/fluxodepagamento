<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fluxo de Pagamento</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
  <style>
    /* --- FUNDO E TIPOGRAFIA BASE --- */
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

body {
    background-color: #1a1a1a;
    color: #f0f0f0;
    font-family: 'Poppins', sans-serif;
    margin: 0;
    padding: 15px;
}

/* --- CONTAINER PRINCIPAL --- */
#simulador-pagamento {
    max-width: 700px;
    margin: auto;
    background-color: #2c2c2c;
    border-radius: 12px;
    padding: 30px;
    border: 1px solid #444;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

/* --- TÍTULOS --- */
.titulo-principal {
    text-align: center;
    background: transparent;
    color: #ffffff;
    padding: 0;
    margin-bottom: 30px;
    font-weight: 600;
    letter-spacing: 1px;
    border-bottom: 1px solid #00aaff;
    padding-bottom: 15px;
}

h3 {
    font-weight: 600;
    color: #00aaff;
    margin-top: 40px;
    border-bottom: 1px solid #444;
    padding-bottom: 10px;
}

/* --- ESTILO DOS INPUTS E CAMPOS --- */
.tabela-entradas {
    width: 100%;
    border-spacing: 0 15px;
}
.tabela-entradas td {
    padding: 4px 8px;
    vertical-align: middle;
}
.tabela-entradas tr {
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.tabela-entradas tr td:first-child {
    width: 30%;
    font-weight: 600;
    color: #ccc;
}
.tabela-entradas tr td:last-child {
    width: 70%;
}
input[type="text"], input[type="number"], input[type="date"] {
    background-color: #3a3a3a;
    color: #f0f0f0;
    border: 1px solid #555;
    border-radius: 8px;
    padding: 10px;
    font-size: 15px;
    width: 100%;
    box-sizing: border-box;
    transition: border-color 0.3s, box-shadow 0.3s;
}
input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus {
    outline: none;
    border-color: #00aaff;
    box-shadow: 0 0 0 3px rgba(0, 170, 255, 0.2);
}

/* --- BOTÕES --- */
.grupo-botoes {
    display: flex;
    gap: 15px;
    margin-top: 25px;
}
.botao-principal {
    flex: 1;
    padding: 12px;
    font-size: 16px;
    font-weight: 600;
    border-radius: 8px;
    border: none;
    color: white;
    cursor: pointer;
    transition: transform 0.2s, background-color 0.2s;
}
.botao-principal:hover:not(:disabled) {
    transform: translateY(-2px);
}
.botao-principal:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
}
.btn-calcular { background-color: #00aaff; }
.btn-pdf { background-color: #d9534f; }
.btn-copiar { background-color: #0275d8; }


/* --- TABELA DE RESULTADOS --- */
.tabela-resultado {
    border-collapse: collapse;
    text-align: center;
    width: 100%;
    margin-top: 20px;
}
.tabela-resultado th, .tabela-resultado td {
    border: 1px solid #444;
    padding: 12px;
}
.tabela-resultado thead {
    background-color: #333;
    color: #00aaff;
    font-weight: 600;
    text-transform: uppercase;
}
.tabela-resultado tbody tr:nth-child(even) {
    background-color: #2c2c2c;
}
.tabela-resultado tfoot tr {
    background: #00aaff;
    color: #1a1a1a;
    font-weight: bold;
}

/* --- RESUMO DO EMPREENDIMENTO --- */
#resumo-empreendimento {
    background: #3a3a3a;
    border-left: 4px solid #00aaff;
    padding: 15px;
    border-radius: 8px;
}

/* --- CORES DE VALIDAÇÃO --- */
#totalPerc.invalido { color: red; font-weight: bold; }
#totalPerc.valido { color: #5cb85c; font-weight: bold; }

/* --- REGRAS DE RESPONSIVIDADE PARA TELEMÓVEIS --- */
@media (max-width: 768px) {
    body {
        padding: 10px; /* Menos padding no body */
    }
    #simulador-pagamento {
        padding: 15px;
    }
    .tabela-entradas tr {
        flex-direction: column;
        align-items: flex-start;
        margin-bottom: 10px;
        gap: 5px; /* Espaço entre label e input */
    }
    .tabela-entradas tr td:first-child,
    .tabela-entradas tr td:last-child {
        width: 100%;
        padding: 0;
    }
    .grupo-botoes {
        flex-direction: column;
    }
    .tabela-wrapper {
        overflow-x: auto; /* Adiciona a barra de rolagem horizontal */
    }
    .tabela-resultado th, .tabela-resultado td {
        font-size: 14px;
        padding: 8px;
    }
}
   
</style>

</head>
<body>
  
<div id="simulador-pagamento">
    <h2 class="titulo-principal">FLUXO DE PAGAMENTO</h2>
    <div class="bloco-entradas">
        <table class="tabela-entradas">
            <tr><td>Nome Empreendimento:</td><td><input type="text" id="nomeEmpreendimento" placeholder="Obrigatório"></td></tr>
            <tr><td>Tipo Unidade:</td><td><input type="text" id="tipoUnidade" placeholder="Obrigatório"></td></tr>
            <tr><td>Área Privativa (m²):</td><td><input type="text" id="areaPrivativa" placeholder="Obrigatório"> </td></tr>
            <tr><td>Nome do Cliente:</td><td><input type="text" id="nomeCliente" placeholder="Opcional"></td></tr>
            <tr><td>Data da Proposta:</td><td><input type="date" id="dataProposta"></td></tr>
            <tr><td>Executivo(a):</td><td><input type="text" id="nomeExecutivo" placeholder="Opcional"></td></tr>
        </table>
        <hr style="border-color: #444; margin: 20px 0;">
        <label>Valor do Imóvel (R$):</label>
        <input type="number" id="valorTotal" placeholder="Digite o valor total" style="margin-top: 10px; margin-bottom: 10px;">
        <table class="tabela-entradas">
            <tr><th>Etapa</th><th>Parcelas</th><th>%</th><th></th><th></th></tr>
            <tr class="linha-etapa" data-etapa="Ato"><td>Ato</td><td><input type="number" class="qnt-input" placeholder="Parcelas"></td><td><input type="number" class="perc-input" placeholder="Porcentagem"></td></tr>
            <tr class="linha-etapa" data-etapa="Sinal"><td>Sinal</td><td><input type="number" class="qnt-input" placeholder="Parcelas"></td><td><input type="number" class="perc-input" placeholder="Porcentagem"></td></tr>
            <tr class="linha-etapa" data-etapa="Mensais"><td>Mensais</td><td><input type="number" class="qnt-input" placeholder="Parcelas"></td><td><input type="number" class="perc-input" placeholder="Porcentagem"></td></tr>
            <tr class="linha-etapa" data-etapa="Anual"><td>Anual</td><td><input type="number" class="qnt-input" placeholder="Parcelas"></td><td><input type="number" class="perc-input" placeholder="Porcentagem"></td></tr>
            <tr class="linha-etapa" data-etapa="Unica"><td>Única</td><td><input type="number" class="qnt-input" placeholder="Parcelas"></td><td><input type="number" class="perc-input" placeholder="Porcentagem"></td></tr>
            <tr class="linha-etapa" data-etapa="Financiamento"><td>Financiamento</td><td><input type="number" class="qnt-input" placeholder="Parcelas"></td><td><input type="number" class="perc-input" placeholder="Porcentagem"></td></tr>
            <tr><td><strong>Total %</strong></td><td></td><td><span id="totalPerc">0.00%</span></td></tr>
        </table>
        <div class="grupo-botoes">
            <button id="btn-calcular" class="botao-principal btn-calcular">Calcular</button>
            <button id="btn-gerar-pdf" class="botao-principal btn-pdf">Gerar PDF</button>
            <button id="btn-copiar-texto" class="botao-principal btn-copiar">Copiar Texto</button>
        </div>
    </div>
    <h3 style="margin-top: 20px;">Resultado:</h3>
    <div id="resumo-empreendimento" style="display: none;"></div>
    <div class="tabela-wrapper">
        <table class="tabela-resultado">
            <thead>
                <tr><th>PARCELAS</th><th>QTDE</th><th>VALOR PARCELA</th><th>SUBTOTAL</th></tr>
            </thead>
            <tbody id="resultado"></tbody>
            <tfoot>
                <tr><td colspan="3">Total</td><td id="totalValor">R$ 0,00</td></tr>
            </tfoot>
        </table>
    </div>
</div>

<script>
    function obterDadosCalculados() {
        const valorTotal = parseFloat(document.getElementById('valorTotal').value) || 0;
        const areaPri = document.getElementById('areaPrivativa').value;
        const areaNum = parseFloat(areaPri) || 0;
        const dados = {
            nomeEmpreendimento: document.getElementById('nomeEmpreendimento').value,
            tipoUnidade: document.getElementById('tipoUnidade').value,
            areaPrivativa: areaPri,
            nomeCliente: document.getElementById('nomeCliente').value,
            dataProposta: document.getElementById('dataProposta').value,
            nomeExecutivo: document.getElementById('nomeExecutivo').value,
            valorTotal: valorTotal,
            precoM2Texto: 'Não aplicável',
            totalGeral: 0,
            parcelas: []
        };
        if (valorTotal > 0 && areaNum > 0) {
            const precoM2 = valorTotal / areaNum;
            dados.precoM2Texto = precoM2.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }
        document.querySelectorAll('.linha-etapa').forEach(linha => {
            const perc = parseFloat(linha.querySelector('.perc-input').value) || 0;
            if (perc > 0) {
                const qtde = parseInt(linha.querySelector('.qnt-input').value) || 0;
                const subtotal = (perc / 100) * valorTotal;
                const valorParcela = qtde > 0 ? subtotal / qtde : 0;
                dados.totalGeral += subtotal;
                dados.parcelas.push({
                    nome: linha.dataset.etapa,
                    qtde: qtde || 1,
                    valorParcela: valorParcela,
                    subtotal: subtotal
                });
            }
        });
        return dados;
    }

    function renderizarResultadosHTML(dados) {
        const resumoContainer = document.getElementById('resumo-empreendimento');
        const resultadoBody = document.getElementById('resultado');
        const totalValorFooter = document.getElementById('totalValor');
        if (dados.nomeEmpreendimento || dados.tipoUnidade || dados.areaPrivativa) {
            resumoContainer.innerHTML = `<p><strong>Cliente:</strong> ${dados.nomeCliente || 'Não informado'}</p><p><strong>Empreendimento:</strong> ${dados.nomeEmpreendimento || 'Não informado'}</p><p><strong>Unidade:</strong> ${dados.tipoUnidade || 'Não informado'}</p><p><strong>Área Privativa:</strong> ${dados.areaPrivativa ? dados.areaPrivativa + ' m²' : 'Não informado'}</p><p><strong>Preço por m²:</strong> ${dados.precoM2Texto}</p>`;
            resumoContainer.style.display = 'block';
        } else {
            resumoContainer.style.display = 'none';
        }
        let corpoTabelaHTML = "";
        dados.parcelas.forEach(p => {
            corpoTabelaHTML += `<tr><td>${p.nome}</td><td>${p.qtde}</td><td>R$ ${p.valorParcela.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td><td>R$ ${p.subtotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td></tr>`;
        });
        resultadoBody.innerHTML = corpoTabelaHTML;
        totalValorFooter.innerHTML = "<strong>" + dados.totalGeral.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) + "</strong>";
    }

    function calcularFluxo() {
        const dadosCalculados = obterDadosCalculados();
        renderizarResultadosHTML(dadosCalculados);
    }

    function copiarTextoProposta() {
        const dados = obterDadosCalculados();
        if (dados.totalGeral === 0) {
            alert("Por favor, calcule um fluxo de pagamento antes de copiar.");
            return;
        }
        let textoParaCopiar = `Cliente: ${dados.nomeCliente || ''}\n\n`;
        textoParaCopiar += `Empreendimento: ${dados.nomeEmpreendimento}\n`;
        textoParaCopiar += `Unidade: ${dados.tipoUnidade}\n`;
        textoParaCopiar += `Área Privativa: ${dados.areaPrivativa} m²\n`;
        textoParaCopiar += `Preço por m²: ${dados.precoM2Texto}\n\n`;
        textoParaCopiar += `PARCELAS\tQTDE\tVALOR PARCELA\tSUBTOTAL\n`;
        dados.parcelas.forEach(p => {
            const valorParcelaFmt = `R$ ${p.valorParcela.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
            const subtotalFmt = `R$ ${p.subtotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
            textoParaCopiar += `${p.nome}\t${p.qtde}\t${valorParcelaFmt}\t${subtotalFmt}\n`;
        });
        const totalGeralFmt = dados.totalGeral.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        textoParaCopiar += `Total\t\t\t${totalGeralFmt}\n`;
        const btnCopiar = document.getElementById('btn-copiar-texto');
        navigator.clipboard.writeText(textoParaCopiar).then(() => {
            const textoOriginal = btnCopiar.innerText;
            btnCopiar.innerText = 'Copiado com Sucesso!';
            btnCopiar.style.backgroundColor = '#5cb85c';
            setTimeout(() => {
                btnCopiar.innerText = "Copiar Texto";
                btnCopiar.style.backgroundColor = '#0275d8';
            }, 2000);
        }).catch(err => {
            console.error('Erro ao copiar texto: ', err);
            alert('Não foi possível copiar o texto.');
        });
    }
    
    async function gerarPdfClientSide() {
        const dados = obterDadosCalculados();
        const camposObrigatorios = {
            "Nome do Empreendimento": dados.nomeEmpreendimento,
            "Tipo Unidade": dados.tipoUnidade,
            "Área Privativa": dados.areaPrivativa,
            "Valor do Imóvel": dados.valorTotal
        };
        for (const [nomeCampo, valorCampo] of Object.entries(camposObrigatorios)) {
            if (!valorCampo || (nomeCampo === "Valor do Imóvel" && valorCampo === 0)) {
                alert(`Por favor, preencha o campo obrigatório: ${nomeCampo}`);
                return;
            }
        }
        const totalPercSpan = document.getElementById('totalPerc');
        if (totalPercSpan && totalPercSpan.innerText !== '100.00%') {
            alert("A soma das porcentagens das parcelas deve ser exatamente 100%.");
            return;
        }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        try {
            const logoUrl = 'https://i.imgur.com/BcWPfEr.png';
            const respostaLogo = await fetch(logoUrl).then(res => res.blob());
            const logoBase64 = await new Promise(resolve => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.readAsDataURL(respostaLogo);
            });
            doc.addImage(logoBase64, 'PNG', 110, 25, 75, 15);
        } catch (error) {
            console.error("Erro ao carregar o logo.", error);
        }
        const dataFormatada = dados.dataProposta ? dados.dataProposta.split('-').reverse().join('/') : 'Não informado';
        doc.setFontSize(18);
        doc.text("Proposta de Pagamento", 14, 22);
        doc.setFontSize(11);
        doc.text(`Empreendimento: ${dados.nomeEmpreendimento || 'Não informado'}`, 14, 32);
        doc.text(`Unidade: ${dados.tipoUnidade || 'Não informado'}`, 14, 38);
        doc.text(`Área Privativa: ${dados.areaPrivativa ? dados.areaPrivativa + ' m²' : 'Não informado'}`, 14, 44);
        doc.text(`Preço por m²: ${dados.precoM2Texto}`, 14, 50);
        doc.text(`Cliente: ${dados.nomeCliente || 'Não informado'}`, 14, 58);
        doc.text(`Data: ${dataFormatada}`, 14, 64);
        const tabelaHead = [["PARCELAS", "QTDE", "VALOR PARCELA", "SUBTOTAL"]];
        const tabelaBody = dados.parcelas.map(p => [
            p.nome,
            p.qtde,
            `R$ ${p.valorParcela.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`,
            `R$ ${p.subtotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`
        ]);
        doc.autoTable({
            head: tabelaHead, body: tabelaBody, startY: 72, theme: 'grid', headStyles: { fillColor: [4, 40, 70] }
        });
        const finalY = doc.lastAutoTable.finalY;
        const totalGeralTexto = dados.totalGeral.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        doc.setFontSize(12);
        doc.setFont("helvetica", "bold");
        doc.text(`Valor no Fluxo: ${totalGeralTexto}`, 14, finalY + 10);
        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        doc.text(`Executivo(a): ${dados.nomeExecutivo || 'Não informado'}`, 14, finalY + 16);
        doc.save(`Fluxo de Pagamento - ${dados.nomeCliente || dados.nomeEmpreendimento || 'simulacao'}.pdf`);
    }

    function atualizarTotalPerc() {
        const spanTotalPerc = document.getElementById('totalPerc');
        const btnCalcular = document.getElementById('btn-calcular');
        let totalPerc = 0;
        document.querySelectorAll('.perc-input').forEach(input => {
            totalPerc += parseFloat(input.value) || 0;
        });
        if (spanTotalPerc) {
            spanTotalPerc.innerText = totalPerc.toFixed(2) + "%";
            const isTotal100 = totalPerc.toFixed(2) === '100.00';
            spanTotalPerc.className = isTotal100 ? 'valido' : 'invalido';
        }
        if (btnCalcular) {
            const isTotal100 = totalPerc.toFixed(2) === '100.00';
            btnCalcular.disabled = !isTotal100;
        }
    }

    setTimeout(function() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('dataProposta').value = today;
        document.getElementById('btn-calcular')?.addEventListener('click', calcularFluxo);
        document.getElementById('btn-gerar-pdf')?.addEventListener('click', gerarPdfClientSide);
        document.getElementById('btn-copiar-texto')?.addEventListener('click', copiarTextoProposta);
        document.querySelectorAll('.perc-input, .qnt-input, #valorTotal, #areaPrivativa').forEach(input => {
            input.addEventListener('input', atualizarTotalPerc);
        });
        atualizarTotalPerc();
    }, 500);
</script>

</body>
</html>

</body>
</html>